from bs4 import BeautifulSoup
import html

def extract_plain_text_from_mathml(mathml_str):
    soup = BeautifulSoup(html.unescape(mathml_str), "xml")  # Giải mã entity
    result = []

    def parse_node(node):
        if node.name == "msup":
            base = parse_node(node.find_all(recursive=False)[0])
            exponent = parse_node(node.find_all(recursive=False)[1])
            return f"{base}^{exponent}"
        elif node.name == "msqrt":
            content = ''.join(parse_node(child) for child in node.find_all(recursive=False))
            return f"√({content})"
        elif node.name == "mfrac":
            num = parse_node(node.find_all(recursive=False)[0])
            denom = parse_node(node.find_all(recursive=False)[1])
            return f"({num}/{denom})"
        elif node.name == "mrow":
            return ''.join(parse_node(child) for child in node.find_all(recursive=False))
        elif node.name in ["mi", "mn", "mo"]:
            return html.unescape(node.text)  # Decode text
        else:
            return ''.join(parse_node(child) for child in node.find_all(recursive=False))

    for mrow in soup.find_all("math"):
        result.append(parse_node(mrow))

    return " ; ".join(result)


# Ví dụ dùng:
mathml_str = '''<p><span><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span id="MathJax-Element-1-Frame" class="mjx-chtml MathJax_CHTML" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>3</mn><mi>x</mi><msup><mi>y</mi><mn>2</mn></msup><msup><mi>x</mi><mn>2</mn></msup><msqrt><mn>5</mn></msqrt><mo>;</mo><mo>-</mo><mn>7</mn><mo>,</mo><mn>5</mn><mi>x</mi><mi>z</mi><mfenced><mrow><mo>-</mo><mn>2</mn></mrow></mfenced><mi>y</mi><mi>z</mi><mo>;</mo><mi>x</mi><mo>(</mo><mn>1</mn><mo>+</mo><mi>&amp;#x3C0;</mi><mo>)</mo><mi>xy</mi><mo>;</mo><mfrac><msup><mi>yx</mi><mn>2</mn></msup><mn>3</mn></mfrac><msup><mi>yz</mi><mn>2</mn></msup></math>" role="presentation" style="font-size: 121%; position: relative;"><span id="MJXc-Node-1" class="mjx-math" aria-hidden="true"><span id="MJXc-Node-2" class="mjx-mrow"><span id="MJXc-Node-3" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">3</span></span><span id="MJXc-Node-4" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.232em; padding-bottom: 0.278em;">x</span></span><span id="MJXc-Node-5" class="mjx-msup"><span class="mjx-base" style="margin-right: -0.006em;"><span id="MJXc-Node-6" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.232em; padding-bottom: 0.461em; padding-right: 0.006em;">y</span></span></span><span class="mjx-sup" style="font-size: 70.7%; vertical-align: 0.513em; padding-left: 0.082em; padding-right: 0.071em;"><span id="MJXc-Node-7" class="mjx-mn" style=""><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.324em;">2</span></span></span></span><span id="MJXc-Node-8" class="mjx-msup"><span class="mjx-base"><span id="MJXc-Node-9" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.232em; padding-bottom: 0.278em;">x</span></span></span><span class="mjx-sup" style="font-size: 70.7%; vertical-align: 0.513em; padding-left: 0px; padding-right: 0.071em;"><span id="MJXc-Node-10" class="mjx-mn" style=""><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.324em;">2</span></span></span></span><span id="MJXc-Node-11" class="mjx-msqrt"><span class="mjx-box" style="padding-top: 0.045em;"><span class="mjx-surd"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.507em; padding-bottom: 0.553em;">√</span></span><span class="mjx-box" style="padding-top: 0.119em; border-top: 1.6px solid;"><span id="MJXc-Node-12" class="mjx-mrow"><span id="MJXc-Node-13" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">5</span></span></span></span></span></span><span id="MJXc-Node-14" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.14em; padding-bottom: 0.553em;">;</span></span><span id="MJXc-Node-15" class="mjx-mo MJXc-space1"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.278em; padding-bottom: 0.416em;">−</span></span><span id="MJXc-Node-16" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">7</span></span><span id="MJXc-Node-17" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="margin-top: -0.181em; padding-bottom: 0.553em;">,</span></span><span id="MJXc-Node-18" class="mjx-mn MJXc-space1"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">5</span></span><span id="MJXc-Node-19" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.232em; padding-bottom: 0.278em;">x</span></span><span id="MJXc-Node-20" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.232em; padding-bottom: 0.278em; padding-right: 0.003em;">z</span></span><span id="MJXc-Node-21" class="mjx-mfenced MJXc-space1"><span id="MJXc-Node-22" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.461em; padding-bottom: 0.599em;">(</span></span><span id="MJXc-Node-23" class="mjx-mrow"><span id="MJXc-Node-24" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.278em; padding-bottom: 0.416em;">−</span></span><span id="MJXc-Node-25" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.324em;">2</span></span></span><span id="MJXc-Node-26" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.461em; padding-bottom: 0.599em;">)</span></span></span><span id="MJXc-Node-27" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.232em; padding-bottom: 0.461em; padding-right: 0.006em;">y</span></span><span id="MJXc-Node-28" class="mjx-mi"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.232em; padding-bottom: 0.278em; padding-right: 0.003em;">z</span></span><span id="MJXc-Node-29" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.14em; padding-bottom: 0.553em;">;</span></span><span id="MJXc-Node-30" class="mjx-mi MJXc-space1"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.232em; padding-bottom: 0.278em;">x</span></span><span id="MJXc-Node-31" class="mjx-mo"><span class="mjx-char MJXc-TeX-size2-R" style="padding-top: 0.921em; padding-bottom: 0.921em;">(</span></span><span id="MJXc-Node-32" class="mjx-mn"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.324em;">1</span></span><span id="MJXc-Node-33" class="mjx-mo MJXc-space2"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.278em; padding-bottom: 0.416em;">+</span></span><span id="MJXc-Node-34" class="mjx-mi MJXc-space2"><span class="mjx-char MJXc-TeX-math-I" style="padding-top: 0.186em; padding-bottom: 0.278em; padding-right: 0.003em;">π</span></span><span id="MJXc-Node-35" class="mjx-mo"><span class="mjx-char MJXc-TeX-size2-R" style="padding-top: 0.921em; padding-bottom: 0.921em;">)</span></span><span id="MJXc-Node-36" class="mjx-mi MJXc-space1"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.14em; padding-bottom: 0.553em;">xy</span></span><span id="MJXc-Node-37" class="mjx-mo"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.14em; padding-bottom: 0.553em;">;</span></span><span id="MJXc-Node-38" class="mjx-mfrac MJXc-space1"><span class="mjx-box MJXc-stacked" style="width: 1.163em; padding: 0px 0.12em;"><span class="mjx-numerator" style="font-size: 70.7%; width: 1.645em; top: -1.641em;"><span id="MJXc-Node-39" class="mjx-msup" style=""><span class="mjx-base"><span id="MJXc-Node-40" class="mjx-mi"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.14em; padding-bottom: 0.553em;">yx</span></span></span><span class="mjx-sup" style="font-size: 70.7%; vertical-align: 0.513em; padding-left: 0px; padding-right: 0.071em;"><span id="MJXc-Node-41" class="mjx-mn" style=""><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.324em;">2</span></span></span></span></span><span class="mjx-denominator" style="font-size: 70.7%; width: 1.645em; bottom: -0.59em;"><span id="MJXc-Node-42" class="mjx-mn" style=""><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.37em;">3</span></span></span><span class="mjx-line" style="border-bottom: 1.3px solid; top: -0.28em; width: 1.163em;"></span></span><span class="mjx-vsize" style="height: 1.577em; vertical-align: -0.417em;"></span></span><span id="MJXc-Node-43" class="mjx-msup"><span class="mjx-base"><span id="MJXc-Node-44" class="mjx-mi"><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.14em; padding-bottom: 0.553em;">yz</span></span></span><span class="mjx-sup" style="font-size: 70.7%; vertical-align: 0.513em; padding-left: 0px; padding-right: 0.071em;"><span id="MJXc-Node-45" class="mjx-mn" style=""><span class="mjx-char MJXc-TeX-main-R" style="padding-top: 0.37em; padding-bottom: 0.324em;">2</span></span></span></span></span></span><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>3</mn><mi>x</mi><msup><mi>y</mi><mn>2</mn></msup><msup><mi>x</mi><mn>2</mn></msup><msqrt><mn>5</mn></msqrt><mo>;</mo><mo>-</mo><mn>7</mn><mo>,</mo><mn>5</mn><mi>x</mi><mi>z</mi><mfenced><mrow><mo>-</mo><mn>2</mn></mrow></mfenced><mi>y</mi><mi>z</mi><mo>;</mo><mi>x</mi><mo>(</mo><mn>1</mn><mo>+</mo><mi>π</mi><mo>)</mo><mi>xy</mi><mo>;</mo><mfrac><msup><mi>yx</mi><mn>2</mn></msup><mn>3</mn></mfrac><msup><mi>yz</mi><mn>2</mn></msup></math></span></span><script type="math/mml" id="MathJax-Element-1"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>3</mn><mi>x</mi><msup><mi>y</mi><mn>2</mn></msup><msup><mi>x</mi><mn>2</mn></msup><msqrt><mn>5</mn></msqrt><mo>;</mo><mo>-</mo><mn>7</mn><mo>,</mo><mn>5</mn><mi>x</mi><mi>z</mi><mfenced><mrow><mo>-</mo><mn>2</mn></mrow></mfenced><mi>y</mi><mi>z</mi><mo>;</mo><mi>x</mi><mo>(</mo><mn>1</mn><mo>+</mo><mi>π</mi><mo>)</mo><mi>xy</mi><mo>;</mo><mfrac><msup><mi>yx</mi><mn>2</mn></msup><mn>3</mn></mfrac><msup><mi>yz</mi><mn>2</mn></msup></math></script></span></p>'''
print(extract_plain_text_from_mathml(mathml_str))
